@using RestaurantQRSystem.Extensions
@using RestaurantQRSystem.Models.Enums
@model ReportViewModel
@{
    ViewData["Title"] = "Satış Raporu";
    Layout = "_AdminLayout";
}

<div class="container-fluid px-4">
    <h1 class="mt-4">Satış Raporu</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">Satış Raporu</li>
    </ol>

    <!-- Tarih Aralığı Seçimi -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Başlangıç Tarihi</label>
                    <input type="date" name="startDate" value="@Model.StartDate.ToString("yyyy-MM-dd")" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Bitiş Tarihi</label>
                    <input type="date" name="endDate" value="@Model.EndDate.ToString("yyyy-MM-dd")" class="form-control" />
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">Raporu Göster</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Özet Bilgileri -->
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <h4 class="mb-0">@Model.TotalSales.ToString("C2")</h4>
                    <div>Toplam Satış</div>
                </div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" href="#">Detaylı Bilgi</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-warning text-white mb-4">
                <div class="card-body">
                    <h4 class="mb-0">@Model.TotalExpenses.ToString("C2")</h4>
                    <div>Toplam Gider</div>
                </div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" asp-action="Expenses">Gider Ekle</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    <h4 class="mb-0">@Model.Profit.ToString("C2")</h4>
                    <div>Net Kâr</div>
                </div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" href="#">Detaylı Bilgi</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-info text-white mb-4">
                <div class="card-body">
                    <h4 class="mb-0">@Model.Orders.Count</h4>
                    <div>Toplam Sipariş</div>
                </div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" href="#">Detaylı Bilgi</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>
    </div>

    

    <!-- Siparişler Tablosu -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Tüm Siparişler
        </div>
        <div class="card-body">
            <table id="ordersTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Sipariş No</th>
                        <th>Tarih</th>
                        <th>Masa</th>
                        <th>Müşteri</th>
                        <th>Tutar</th>
                        <th>Durum</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in Model.Orders)
                    {
                        <tr>
                            <td>@order.Id</td>
                            <td>@order.OrderDate.ToString("dd.MM.yyyy HH:mm")</td>
                            <td>@order.Table.Name</td>
                            <td>@(string.IsNullOrEmpty(order.CustomerName) ? "Misafir" : order.CustomerName)</td>
                            <td>@order.TotalAmount.ToString("C2")</td>
                            <td>
                                <span class="badge bg-@(order.Status == OrderStatus.Received ? "primary" :
                                                   order.Status == OrderStatus.Preparing ? "warning" :
                                                   order.Status == OrderStatus.Ready ? "success" :
                                                   order.Status == OrderStatus.Delivered ? "info" :
                                                   order.Status == OrderStatus.Cancelled ? "danger" : "secondary")">
                                    @order.Status.ToString()
                                </span>
                            </td>
                            <td>
                                <a asp-area="Admin" asp-controller="Order" asp-action="Details" asp-route-id="@order.Id" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a asp-action="Invoice" asp-route-id="@order.Id" class="btn btn-sm btn-primary">
                                    <i class="fas fa-file-invoice"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- En Çok Satan Ürünler -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-star me-1"></i>
            En Çok Satan Ürünler
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ürün</th>
                        <th>Satış Adedi</th>
                        <th>Toplam Tutar</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.TopProducts.Count; i++)
                    {
                        var product = Model.TopProducts[i];
                        <tr>
                            <td>@(i + 1)</td>
                            <td>@product.ProductName</td>
                            <td>@product.Quantity</td>
                            <td>@product.TotalSales.ToString("C2")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Giderler Tablosu -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-money-bill-wave me-1"></i>
                Giderler
            </div>
            <a asp-action="Expenses" class="btn btn-sm btn-success">
                <i class="fas fa-plus-circle"></i> Yeni Gider Ekle
            </a>
        </div>
        <div class="card-body">
            @if (!Model.Expenses.Any())
            {
                <div class="alert alert-info">Seçilen tarih aralığında gider kaydı bulunmamaktadır.</div>
            }
            else
            {
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Açıklama</th>
                            <th>Kategori</th>
                            <th>Tutar</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var expense in Model.Expenses)
                        {
                            <tr>
                                <td>@expense.Date.ToString("dd.MM.yyyy")</td>
                                <td>@expense.Description</td>
                                <td>@expense.Category.GetDisplayName()</td>
                                <td>@expense.Amount.ToString("C2")</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3" class="text-end">Toplam Gider:</th>
                            <th>@Model.TotalExpenses.ToString("C2")</th>
                        </tr>
                    </tfoot>
                </table>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        $(document).ready(function() {
            // DataTable
            $('#ordersTable').DataTable({
                order: [[1, 'desc']], // Tarihe göre sırala
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/tr.json'
                }
            });

            // Sipariş Durum Grafiği
            var statusCtx = document.getElementById('orderStatusChart').getContext('2d');
            var statusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Alındı', 'Hazırlanıyor', 'Hazır', 'Teslim Edildi', 'İptal'],
                    datasets: [{
                        data: [
        @Model.ReceivedCount,
        @Model.PreparingCount,
        @Model.ReadyCount,
        @Model.DeliveredCount,
        @Model.CancelledCount
                        ],
                        backgroundColor: [
                            '#0d6efd', // primary
                            '#ffc107', // warning
                            '#198754', // success
                            '#0dcaf0', // info
                            '#dc3545'  // danger
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Kategori Bazında Satışlar Grafiği
            var categoryCtx = document.getElementById('categorySalesChart').getContext('2d');
            var categoryChart = new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: [@Html.Raw(string.Join(",", Model.SalesByCategory.Select(c => $"'{c.CategoryName}'")))],
                    datasets: [{
                        label: 'Satış Tutarı (₺)',
                        data: [@string.Join(",", Model.SalesByCategory.Select(c => c.TotalSales))],
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    </script>
}
