@using RestaurantQRSystem.Models.Enums
@model RestaurantQRSystem.Models.Order
@{
    ViewData["Title"] = $"Sipariş #{Model.Id}";
    Layout = "_AdminLayout";
}

<div class="container-fluid px-4">
    <h1 class="mt-4">Sipariş Detayı</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Home" asp-action="Index">Dashboard</a></li>
        <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Order" asp-action="Index">Siparişler</a></li>
        <li class="breadcrumb-item active">Sipariş #@Model.Id</li>
    </ol>
    
    <div class="row">
        <div class="col-xl-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-utensils me-1"></i>
                        Sipariş İçeriği
                    </div>
                    <div>
                        <span class="badge bg-@(Model.Status == OrderStatus.Received ? "primary" : 
                                              Model.Status == OrderStatus.Ready ? "success" : 
                                              Model.Status == OrderStatus.Cancelled ? "danger" : "secondary")">
                            @Model.Status.ToString()
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Ürün</th>
                                <th class="text-center">Adet</th>
                                <th class="text-center">Birim Fiyat</th>
                                <th class="text-end">Toplam</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.OrderItems)
                            {
                                <tr>
                                    <td>@item.Product.Name</td>
                                    <td class="text-center">@item.Quantity</td>
                                    <td class="text-center">@item.UnitPrice.ToString("0.00")₺</td>
                                    <td class="text-end">@((item.UnitPrice * item.Quantity).ToString("0.00"))₺</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-end">Toplam:</th>
                                <th class="text-end">@Model.TotalAmount.ToString("0.00")₺</th>
                            </tr>
                        </tfoot>
                    </table>
                    
                    @if (!string.IsNullOrEmpty(Model.CustomerNote))
                    {
                        <div class="alert alert-info mt-3">
                            <strong>Müşteri Notu:</strong> @Model.CustomerNote
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-xl-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-info-circle me-1"></i>
                    Sipariş Bilgileri
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Sipariş No:</dt>
                        <dd class="col-sm-8">@Model.Id</dd>
                        
                        <dt class="col-sm-4">Tarih:</dt>
                        <dd class="col-sm-8">@Model.OrderDate.ToString("dd.MM.yyyy HH:mm")</dd>
                        
                        <dt class="col-sm-4">Masa:</dt>
                        <dd class="col-sm-8">@Model.Table.Id - @Model.Table.Name</dd>
                        
                        <dt class="col-sm-4">Müşteri:</dt>
                        <dd class="col-sm-8">@(string.IsNullOrEmpty(Model.CustomerName) ? "Misafir" : Model.CustomerName)</dd>
                    </dl>
                    
                    <hr />
                    
                    <form asp-action="UpdateStatus" method="post" id="statusForm">
                        <input type="hidden" name="id" value="@Model.Id" />
                        
                        <div class="mb-3">
                            <label for="status" class="form-label">Sipariş Durumu</label>
                            <select class="form-select" id="status" name="status">
                                <option value="1" selected="@((int)Model.Status == 1)">Alındı</option>
                                <option value="2" selected="@((int)Model.Status == 2)">Hazırlanıyor</option>
                                <option value="3" selected="@((int)Model.Status == 3)">Hazır</option>
                                <option value="4" selected="@((int)Model.Status == 4)">Teslim Edildi</option>
                                <option value="5" selected="@((int)Model.Status == 5)">İptal Edildi</option>
                            </select>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Durumu Güncelle</button>
                        </div>
                    </form>
                    
                    <hr />
                    
                    <div class="d-grid gap-2">
                        <a asp-action="Index" class="btn btn-outline-secondary">Siparişlere Dön</a>
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#printModal">
                            <i class="fas fa-print me-1"></i> Yazdır
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Yazdırma Modal -->
<div class="modal fade" id="printModal" tabindex="-1" aria-labelledby="printModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="printModalLabel">Sipariş Yazdır</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="printArea">
                <div class="text-center mb-3">
                    <h4>Restaurant Name</h4>
                    <p>Address Information</p>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <p><strong>Order #:</strong> @Model.Id</p>
                    </div>
                    <div class="col-6 text-end">
                        <p><strong>Date:</strong> @Model.OrderDate.ToString("dd.MM.yyyy HH:mm")</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <p><strong>Table:</strong> @Model.Table.Id</p>
                    </div>
                    <div class="col-6 text-end">
                        <p><strong>Customer:</strong> @(string.IsNullOrEmpty(Model.CustomerName) ? "Guest" : Model.CustomerName)</p>
                    </div>
                </div>

                <hr />

                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th class="text-center">Qty</th>
                            <th class="text-end">Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.OrderItems)
                        {
                            <tr>
                                <td>@item.Product.Name</td>
                                <td class="text-center">@item.Quantity</td>
                                <td class="text-end">@((item.UnitPrice * item.Quantity).ToString("0.00"))₺</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="2" class="text-end">Total:</th>
                            <th class="text-end">@Model.TotalAmount.ToString("0.00")₺</th>
                        </tr>
                    </tfoot>
                </table>

                @if (!string.IsNullOrEmpty(Model.CustomerNote))
                {
                    <div class="mt-3">
                        <strong>Note:</strong> @Model.CustomerNote
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="window.printContent()">Print</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/signalr/dist/browser/signalr.min.js"></script>
    <script>
        $(document).ready(function() {
            // Status değişikliklerini dinle
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/orderHub")
                .withAutomaticReconnect()
                .build();

            connection.start().catch(function(err) {
                console.error(err);
            });

            // Status değişikliğinde sayfayı yenile
            connection.on("OrderStatusUpdated", function(orderId, status) {
                if (orderId == @Model.Id) {
                    location.reload();
                }
            });

            // Status form
            $("#status").change(function() {
                $("#statusForm").submit();
            });
        });
        
         window.printContent = function() {
        const printContents = document.getElementById("printArea")?.innerHTML;
        if (!printContents) {
            console.error("printArea bulunamadı!");
            return;
        }
        function printContent() {
            const printContents = document.getElementById("printArea").innerHTML;
            const originalContents = document.body.innerHTML;

            document.body.innerHTML = `
                <html>
                <head>
                    <title>Sipariş #@Model.Id</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 12px; }
                        .text-center { text-align: center; }
                        .text-end { text-align: right; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 5px; }
                        th { border-bottom: 1px solid #ddd; }
                        .table-sm th, .table-sm td { padding: 3px; }
                    </style>
                </head>
                <body>
                    ${printContents}
                </body>
                </html>
            `;
            }
            
    </script>
    <script>
       
    </script>
}